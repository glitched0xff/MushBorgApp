<%- include ('../header') %>
<%- include ('../navbar') %>
<%- include ('../sidebar') %>

  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Gestione species</h1>
            <button type="button" class="btn btn-xs btn-primary" id="modSpecies_Btn" style="display: none;"><i class="fas fa-plus"></i> Modifca species</button>
            <button type="button" class="btn btn-xs btn-primary" id="pdfSpecies_Btn" style="display: none;"><i class="fa fa-print" aria-hidden="true"></i></button>
             <button type="button" class="btn btn-xs btn-primary" id="newSpecies_Btn"><i class="fas fa-plus"></i> Nuova species</button>
              <button class="btn btn-xs btn-primary" id="backToMain_Btn" style="display: none;"> <i class="fas fa-long-arrow-alt-left"></i> Torna a elenco species</button>
           
          </div>
          
        </div>
      </div>
    </div>
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <!-- Species card -->
          <div class="card w-100" id="tableSpecies_Crd">
            <div class="card-body">
              <table class="display table table-striped table-bordered compact" id="specie_Tbl" style="width: 100%;">
                <thead>
                    <tr>
                        <th style="width: 40px; "></th>
                        <th>species_name</th>
                        <th>description</th>
                        <th style="width: 200px; ">shortCode</th>
                        <th>Data creazione</th>
                     
                    </tr>
                </thead>
                <tbody id="specie_Tblb">
                    
                </tbody>
            </table>
            </div>
          </div>
          <!-- Show/mod species Card -->
          <div class="card w-100" id="showSpecies_Crd" style="display: none;">
            <form id="specie_Frm" class="p-3">

              <div class="row m-2">
                <%- include('../include/ejsForm',
                { classTxt: "specieText",
                    classField: "specieForm",
                    form:[
                    { 
                      type:"hidden",
                      fieldName:"idSpecies"
                    },
                    { type:"startRow"},
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"species_name",
                      label:"Nome specie",
                      required:true, 
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"description",
                      label:"Descrizione",
                      required:true, 
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"shortCode",
                      label:"Short code",
                      required:true,
                      maxlength:3,
                    },
                     { type:"endRow"},
                     { type:"startRow"},
                     {
                      type:"text",
                      classBox:"col-4",
                      fieldName:"synonyms",
                      label:"Nome comune/sinonimo",
                    },
                    {
                      type:"text",
                      classBox:"col-4",
                      fieldName:"habitat",
                      label:"Habitat",
                    },
                    {
                      type:"text",
                      classBox:"col-4",
                      fieldName:"substrate",
                      label:"Substrato ideale",
                      required:true, 
                    },
                     { type:"endRow"},
                     { type:"startRow"},
                     
                      {
                        type:"textarea",
                        classBox:"col-12",
                        fieldName:"longDesc",
                        label:"Descrizione",
                        col:10,
                        row:6
                      },
                     { type:"endRow"},
                    ]  
                }) %>
              </div>
                <div class="row w-100" style="display: none;" id="specie_Frm_Btn">
                  <button class="btn btn-xs btn-primary mx-1" id="saveSpecies_Btn" > <i class="fas fa-pen"></i> Salva species </button>
                  <button class="btn btn-xs btn-secondary mx-1" id="abortSpecies_Btn"  > <i class="fas fa-pen"></i> Annulla modifica </button>
                </div>
            </form>
          </div>
          <!-- Dati coltivazione -->
           <div class="card w-100 " style="display: none;" id="parameter_Crd"><!-- collapsed-card -->
            <div class="card-header">
              <h3 class="card-title">Dati di coltivazione
                <button class="btn btn-xs btn-primary mx-1" id="modParameter_Btn"> 
              <i class="fas fa-plus"></i> 
                Modifica dati
              </button>
              <button class="btn btn-xs btn-primary mx-1" id="importParameter_Btn" style="display: none;"> 
              <i class="fas fa-plus"></i> 
                Importa parametri
              </button>
              </h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="maximize"><i class="fas fa-expand"></i></button>
              </div>
            </div>
            <div class="card-body">
              <form id="parameter_Frm">
              <div class="row">
                <span class="col-12 text-bold border-top border-bottom"> Propagazione</span>
                <%- include('../include/ejsForm',
                { classTxt: "parameterText",
                    classField: "parameterForm",
                    form:[
                    { 
                      type:"hidden",
                      fieldName:"idSpeciesParameter"
                    },
                    { type:"startRow", class:"p-2"},
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"incubation_temp",
                      label:"Temperatura",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"incubation_hum",
                      label:"Umidità",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"incubation_len",
                      label:"Durata in giorni",
                      required:'', 
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"incubation_co2",
                      label:"C02",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"incubation_airExch",
                      label:"Ricambio d'aria",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"incubation_light",
                      label:"Luce",
                    },
                     { type:"endRow"},
                    ]  
                }) %>
              </div>  
              <div class="row">
                <span class="col-12 text-bold border-top border-bottom"> Primordia</span>
                <%- include('../include/ejsForm',
                { classTxt: "parameterText",
                    classField: "parameterForm",
                    form:[
                    { type:"startRow", class:"p-2"},
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"primordia_temp",
                      label:"Temperatura",
                    },
                     {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"primordia_hum",
                      label:"Umidità",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"primordia_len",
                      label:"Durata in giorni",
                      required:'', 
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"primordia_co2",
                      label:"C02",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"primordia_airExch",
                      label:"Ricambio d'aria",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"primordia_light",
                      label:"Luce",
                    },
                     { type:"endRow"},
                    ]  
                }) %>
              </div>

              <div class="row">
                <span class="col-12 text-bold border-top border-bottom"> Fruttificazione</span>
                <%- include('../include/ejsForm',
                { classTxt: "parameterText",
                    classField: "parameterForm",
                    form:[
                    { type:"startRow", class:"p-2"},
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"fructification_temp",
                      label:"Temperatura",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"fructification_hum",
                      label:"Umidità",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"fructification_len",
                      label:"Durata in giorni",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"fructification_co2",
                      label:"C02",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"fructification_airExch",
                      label:"Ricambio d'aria",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"fructification_light",
                      label:"Luce",
                    },
                     { type:"endRow"},
                    ]  
                }) %>
              </div>

              <div class="row">
                <span class="col-12 text-bold border-top border-bottom"> Coltivazione</span>
                <%- include('../include/ejsForm',
                { classTxt: "parameterText",
                    classField: "parameterForm",
                    form:[
                    { type:"startRow", class:"p-2"},
                    
                     {
                      type:"checkbox",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"outdoor",
                      label:"Outdoor",
                    },
                    {
                      type:"checkbox",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"indoor",
                      label:"Indoor",
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"liked_substrate",
                      label:"Substrati",
                    },
                     { type:"endRow"},
                    ]  
                }) %>
              </div>
              <div class="row w-100" style="display: none;" id="parameter_Btn">
                  <button class="btn btn-xs btn-primary mx-1" id="saveParameter_Btn" > <i class="fas fa-pen"></i> Salva parametri </button>
                  <button class="btn btn-xs btn-secondary mx-1" id="abortParameterBtn"  > <i class="fas fa-pen"></i> Annulla modifica </button>
                </div>
              </form>
            </div>
          </div>
          

        </div>
    </div>
</div>
</section>

</div>



<%- include ('../footer') %>
<%- include ('../jsLoad') %>
<script>
let redirectId= <%- JSON.stringify( redirectId) %>
let specieId
let importParam
let speciesData

async function  drawTable (){
  await $.ajax({
      type: "GET",
      url: "/strain/species/getAll",
      success: async function (response) {
        console.log(response)
          let html=""
          for (let i = 0; i < response.species.length; i++) {
              let el=response.species[i]
              let delBtnDisable=""
              if (el.strains>0){
                delBtnDisable="disabled"
              }
              html+=`<tr>
                          <td>
                          <button type="button" name="" id="showBtn${el.id}" 
                          class="btn btn-primary btn-xs showSpecies" style="width:25px"
                          idSpecies="${el.id}" specieName="${el.species_name}">
                            <i class="fa fa-eye fa-sm" aria-hidden="true"></i>
                        </button>
                        <button type="button" name="" id="delete${el.id}" 
                        class="btn btn-danger btn-xs deleteSpecies_Btn" style="width: 25px" 
                        idSpecies="${el.id}" specieName="${el.species_name}" ${delBtnDisable}>
                          <i class="fa fa-trash fa-sm " aria-hidden="true"></i>
                        </button>
                      </td>
                              <td>${el.species_name}</td>
                              <td>${el.description}</td>
                              <td>${el.shortCode}</td>
                              <td>${moment(el.createdAt).format("DD-MM-YY HH:mm")}</td>
                          </tr>`
              
              }
              await $('#specie_Tbl').DataTable({pageLength: 50}).clear().rows.add($(html)).draw();
          }
  });
}

async function drawShowSpecies(redirectId) {
    //$("#saveSpecies_Btn").hide()
    strainId=redirectId
    await $.ajax({
      type: "GET",
      url: "/strain/species/getOneSpecie?id="+redirectId,
      success: async function (response) {
        console.log(response)
        speciesData=response.specie
        $("inoculumElement").show();
        $("spawnElement").show();
        $("propagationElement").show();
        $("#modSpecies_Btn").show()
         for (const [key, value] of Object.entries(speciesData)) {
              if($("#"+key+"_Fld").attr("tp")=="textField"){
                $("#"+key+"_Fld").val(value)
              }
              if($("#"+key+"_Fld").attr("tp")=="selectField"){
                $("#"+key+"_Fld").val(value).change();
                if (key=="species"){
                  $("#species_Fld").val(speciesData.species_code).change();
                }
              }
              switch (key) {
                case "supplierId":
                  $("#supplierId_Show").html(speciesData.supplier?speciesData.supplier.supplier_name:"-")
                  break;
                case "outdoor":
                  $("#outdoor_Show").html(speciesData.outdoor==1?"Sì":"No")                  
                  speciesData.outdoor==1?$("#outdoor_Fld").prop('checked', true):$("#outdoor_Fld").prop('checked', false);
                  break;
                case "indoor":
                  $("#indoor_Show").html(speciesData.indoor==1?"Sì":"No")                  
                  speciesData.indoor==1?$("#indoor_Fld").prop('checked', true):$("#indoor_Fld").prop('checked', false);
                  break;
                case "buyed":
                  console.log(speciesData.buyed)
                  $("#buyed_Show").html(speciesData.buyed ?moment(speciesData.buyed).format("DD-MM-YY"):"-")
                  $('#buyed_DT').datetimepicker({ format:"DD-MM-YY",defaultDate:moment(speciesData.buyed)})
                  break;
                case "conservationMedia":
                  let txt=$("#conservationMedia_Fld option:selected").text();
                  $("#conservationMedia_Show").html(speciesData.conservationMedia?txt:"-")
                  break;
                default:
                  $("#"+key+"_Show").html(value?value:"-")
                  break;
                }
            }
        //---- Form //
        $("#showSpecies_Crd").show()
        //$("#parameter_Crd").show();
        $(".lotti_Crd").show();
        $("#newSpecies_Crd").hide()
        $("#tableSpecies_Crd").hide()
        $("#newSpecies_Btn").hide()
        $("#backToMain_Btn").show()
        $(".specieText").show()
        $(".specieForm").hide()
        $(".parameterText").show()
        $(".parameterForm").hide()
      }
    });   
  
}

async function drawTableStrain(params) {
  $.ajax({
    type: "GET",
    url: "/strain/species/getStrainBySpecies?id="+speciesData.specieId,
    success: function (response) {
      console.log(response)
    }
  });  
}

$(document).ready(async function () {
  // init 
   if (redirectId!=null){
      await drawShowSpecies(redirectId)
      $("#idSpecies_Fld").val(redirectId);
      $("#idSpeciesParameter_Fld").val(redirectId);
      $("#pdfSpecies_Btn").show();
    }
    else{
      tableSpecies=$('#strain_Tbl').DataTable({responsive: true,pageLength: 50});
      await drawTable()
      $("#idSpecies_Fld").val("");
      $("#idSpeciesParameter_Fld").val("");
    }

    $(document).on("click",".showSpecies", async function(e){
      let idstrain=$(this).attr("idspecies")
      window.location="/strain/species?redirectId="+idstrain   
  })

    $(document).on("click",".deleteSpecies_Btn", function (e) { 
      e.preventDefault();
      let idSpecie=$(this).attr("idspecies")
      let specieName=$(this).attr("speciename")
      let c=confirm(`Si sta eliminando la specie ${specieName}, continuare? ` )
      if(c){
        $.ajax({
          type: "DELETE",
          url: "/strain/species/deleteSpecie?id="+idSpecie,
          success: async function (response) {
            await drawTable()
          }
        });
      }
    });
    

  // Gestione dati
    $("#newSpecies_Btn").click(function (e) { 
      e.preventDefault();
      $("#showSpecies_Crd").show()
      //  $("#parameter_Crd").show();
        $("#newSpecies_Crd").hide()
        $("#tableSpecies_Crd").hide()
        $("#newSpecies_Btn").hide()
        $(".speciesText").hide()
        $(".speciesForm").show()
        $(".parameterText").show()
        $(".parameterForm").hide()
        $("#specie_Frm_Btn").show();
    });

    $("#saveSpecies_Btn").click(function (e) { 
      e.preventDefault();
      let check=checkForm("specie_Frm")
      if(check){
        $.ajax({
          type: "POST",
          url: "/strain/species/newSpecie",
          data: $("#specie_Frm").serialize(),
          success: function (response) {
            console.log(response)
            window.location="/strain/species?id="+response.id
          }
        });
      }
      
    });

    $("#modSpecie_Btn").click(function (e) { 
      e.preventDefault();
      $(".specieForm").show()
      $(".specieText").hide()
      $("#specie_Frm_Btn").show();
      
    });

    $("#abortSpecie_Btn").click(function (e) { 
      e.preventDefault();
      window.location.reload()
    });

    $("#backToMain_Btn").click(function (e) { 
        e.preventDefault();
         window.location='/strain/species'
      });
})
</script>
<%- include ('../closeTag') %>
