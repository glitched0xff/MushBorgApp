<%- include ('../header') %>
<%- include ('../navbar') %>
<%- include ('../sidebar') %>

  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Inoculi
              <button class="btn btn-xs btn-primary" id="modInoculi_Btn" style="display: none;"><i class="fas fa-plus"></i> Modifca inoculo</button>
              <button type="button" class="btn btn-xs btn-primary" id="newInoculi_Btn"><i class="fas fa-plus"></i> Nuovo inoculo</button>
              <button class="btn btn-xs btn-primary" id="backToMain_Btn" style="display: none;"> <i class="fas fa-long-arrow-alt-left"></i> Torna a elenco inoculi</button>
            </h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Inoculi</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
    <section class="content">
      <div class="container-fluid">
        <!-- Table inoculi -->
        <div class="row" style="width: 100%;" id="inoculi_Table" style="display: none;">
          <div class="card w-100" id="tableInoculi_Crd">
            <div class="card-body">
              <table class="display table table-striped table-bordered compact" id="inoculi_Tbl" style="width: 100%;">
                <thead>
                    <tr>
                        <th style="max-width: 10%; "></th>
                        <th style="max-width:20%">Codice</th>
                        <th style="max-width:25%">Nome</th>
                        <th style="max-width:15%">Qt</th>
                        <th style="max-width:25%">Strain</th>
                        <th style="max-width:8  %">Creato il</th>
                    </tr>
                </thead>
                <tbody id="inoculi_Tblb">  
                </tbody>
            </table>
            </div>
          </div>
        </div>
        <!-- Data inoculi -->
        <div class="card w-100" id="inoculi_Data" style="display: none;">
            <div class="card-body">
              <h4 id="titoloForm">
                Nuovo inoculo
              </h4>

              <div class="row">
                <div class="col">
              <form id="inoculi_FRM" class="p-3">
                <div class="row w-100">
                    <div class="col">

                <!-- <div class="row border-bottom mb-2 pb-2 font-weight-bold w-100">
                  Elemento <span id="inoculiCode" class="mx-1"></span> 
                  <button class="btn btn-xs btn-primary mx-1" id="backToMain_Btn"> <i class="fas fa-long-arrow-alt-left"></i> Torna a elenco inoculii</button>
                  <button class="btn btn-xs btn-primary mx-1" id="modInoculo_Btn"> <i class="fas fa-pen"></i> Modifica inoculio</button>
                </div> -->
                <%- include('../include/ejsForm',
                  { classTxt: "inoculiText",
                    classField: "inoculiForm",
                    form:[
                    { 
                      type:"hidden",
                      fieldName:"idInoculo"
                    },
                    { type:"startRow"},
// purchased
                    {
                      type:"text",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"inoculum_name",
                      label:"Nome inoculo",
                      required:true, 
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"code_inoculum",
                      label:"Codice inoculo",
                      disabled:true, 
                    },
                    {
                      type:"select",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"strainId",
                      label:"Strain",
                      firstField:"Seleziona la strain",
                      required:true, 
                      option:strainDD
                    },
                    {
                      type:"select",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"containerId",
                      label:"Contenitore",
                      firstField:"Seleziona il contenitore",
                      required:true, 
                      option:containerDD
                    },
                    {
                      type:"number",
                      classBox:"col-md-1 col-sm-6",
                      fieldName:"n_container",
                      label:"Quantità",
                      required:true, 
                    },
                    { type:"endRow"},
                     {type:"startRow"},
                    {
                      type:"checkbox",
                      classBox:"col-md-1 col-sm-6",
                      fieldName:"purchased",
                      label:"Acquistato",
                    },
                    {
                      type:"select",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"supplierId",
                      label:"Fornitore",
                      firstField:"Seleziona fornitore",
                      disabled:true,
                      option:supplierDD
                    },
                    {
                      type:"date",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"purchased_date",
                      label:"Data acquisto",
                    },
                    {
                      type:"checkbox",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"fromSample",
                      label:"Da campione",
                    },
                    {
                      type:"select",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"sampleType",
                      label:"Tipo di campione",
                      firstField:"Seleziona tipo campione",
                      disabled:true,
                      option:sampleTypeDD
                    },
                     { type:"endRow"},
                     {type:"startRow"},
                    {
                      type:"select",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"substrateId",
                      label:"Substrato",
                      firstField:"Seleziona substrato",
                      required:true, 
                      option:substrateDD
                    },
                    {
                      type:"select",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"storageId",
                      label:"Magazzino",
                      firstField:"Seleziona il magazzino",
                      required:true, 
                      option:storagesDD
                    },
                    { type:"endRow"},
                     {type:"startRow"},
                    {
                      type:"date",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"createLot",
                      label:"Data creazione",
                      required:true
                    },
                    
                    {
                      type:"date",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"expected_maturation_date",
                      label:"Data prevista maturazione",
                      required:true
                    },
                    {
                      type:"date",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"exp_date",
                      label:"Data scadenza",
                      required:true
                    },
                    { type:"endRow"}
                    ]  
                }) %>
                <div class="row w-100 mt-2" id="setInoculo_Row" >
                  
                    <div class="col-12 h5">Elementi di inoculo
                      <button type="button" class="btn btn-primary btn-xs" data-toggle="modal" 
                            data-target="#inoculiModal" id="selInoculo_BtnMdl" style="display: none;">
                            Seleziona seeds
                          </button>
                    </div>
                    <div id="addSeedTbl_Div" style="display: none;" class="w-100"></div>
                    <table class="table table-sm mb-0" id="setSeed_Tbl" style="display: none;width: 50%;">
                      <thead>
                        <tr>
                          <th>Codice seed</th>
                        </tr>
                      </thead>
                      <tbody id="setSeed_Tblb">
                      </tbody>
                    </table>
                </div>
                </div>
                </div>
                </form>
                
                <div class="row w-100 m-3">
                  <button class="btn btn-xs btn-primary mx-1" id="saveNewInoculo_Btn" style="display: none;" idElement=""> <i class="fas fa-pen"></i> Salva inoculo </button>
                  <button class="btn btn-xs btn-primary mx-1" id="saveInoculo_Btn" style="display: none;" idElement=""> <i class="fas fa-pen"></i> Salva modifica </button>
                  <button class="btn btn-xs btn-secondary mx-1" id="abortInoculo_Btn" style="display: none;" idElement=""> <i class="fas fa-pen"></i> Annulla modifica </button>
                </div>
                </div>
               </div>
              </div>
              <div class="row m-3" id="mushElement_Div">
              <div class="col">
                 <div class="row" >
                    <div class="col-12 h5">
                        Elementi lotto
                        <button type="button"  data-toggle="modal" 
                data-target="#movimentazioni_Mdl" 
                class="btn btn-primary btn-xs mx-2 movimentazioneBtn" disabled type="all"><i class="fas fa-truck-moving"></i> Movimenta elementi</button>
                <button type="button" class="btn btn-primary btn-xs mx-2" id="exportCsv_Btn"><i class="fas fa-file-csv"></i> Esporta csv</button>
                      </div>
                  <table class="table table-sm " id="mushElement_Tbl">
                      <thead>
                        <tr>
                          <th style="width: 10px;"></th>
                          <th style="width: 10px;">Codice elemento</th>
                          <th>Stato elemento</th>
                          <th>Magazzino</th>
                          <th>Note</th>
                          <th>Data prelievo</th>
                        </tr>
                      </thead>
                      <tbody id="mushElement_Tblb">
                        
                      </tbody>
                    </table>
                 </div>
              </div>
            </div>
            </div>
        </div>
</section>
<!-- Modal moviemntazione -->
 <div class="modal fade" id="movimentazioni_Mdl" tabindex="-1" role="dialog" aria-labelledby="#movimentazioni_MdlTitleId" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="movimentazioni_MdlTitleId">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
      </div>
      <div class="modal-body">
        <div class="modal-body">
          <form id="movimentazioni_Frm">
            <input type="hidden" name="movimentaIdElement" id="movimentaIdElement">
            <input type="hidden" name="movimentaTypeElement" id="movimentaTypeElement">

            <div class="row">
              <div class="col-4">
                <div class="form-check form-check-inline">
                <label class="form-check-label">
                  <input class="form-check-input" type="checkbox" name="movimentaAll_Ckb" id="movimentaAll_Ckb" value="moveAll"> Movimentare tutto il lotto? 
                </label>
              </div>
              </div>
              <div class="col-4 movimentaAll_Div" style="display: none;">
                <div class="form-group">
                  <label for="">Provenienza intero lotto</label>
                  <select class="form-control" name="movimentaFrom_Sel" id="movimentaFrom_Sel" disabled>
                    
                  </select>
                </div>
              </div>
              <div class="col-4 movimentaAll_Div" style="display: none;" >
                <div class="form-group">
                  <label for="">Destinazione intero lotto</label>
                  <select class="form-control" name="movimentaAll_Sel" id="movimentaAll_Sel" disabled>
                    
                  </select>
                </div>
              </div>
              
            </div>
            <div class="row w-100">
              <table class="table" id="movimenti_Tbl">
                <thead>
                  <tr>
                    <th>Elemento</th>
                    <th>Mag. atttuale</th>
                    <th>Mag. destinazione</th>
                  </tr>
                </thead>
                <tbody id="movimenti_Tblb">
                  
                </tbody>
              </table>
              <div>
            <div class="row">
              <button type="button" class="btn btn-primary btn-xs" id="saveMovimentation">Movimenta gli elementi</button>
            </div>
          </div>
            </div>
          </form>
        </div>
    </div>
 </div>
 </div>
 </div>

 <!-- Modal Seleziona seeds-->
<div class="modal fade" id="inoculiModal" tabindex="-1" aria-labelledby="inoculiModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="inoculiModalLabel">Seleziona seeds</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row w-100">
          <div class="form-group col-12">
            <label for="">Cerca elemento</label>
            <input type="text" class="form-control" name="" id="liveSearch" >
          </div>
          <div id="liveResult_Div" style="height:500px; overflow-y: scroll;" class="col-12">
            
          </div>
        </div>
       
      </div>
    </div>
  </div>
</div>

</div>


<%- include ('../footer') %>
<%- include ('../jsLoad') %>
<script>
  let idInoculi
    let storagesDD= <%- JSON.stringify( storagesDD) %>
    let sampleTypeDD= <%- JSON.stringify( sampleTypeDD) %>
    let supplierDD= <%- JSON.stringify( supplierDD) %>
  let redirectId= <%- JSON.stringify( redirectId) %>
  let dataElement
  let filterCategory="INOCULUM"
  let inoculiList
  let tempInoculiArray=[]
  async function  drawTableInoculi (){
   await $.ajax({
        type: "GET",
        url: "/inoculum/getAll",
        success: async function (response) {
          console.log(response)
            let html=""
            for (let i = 0; i < response.inoculum.length; i++) {
                let el=response.inoculum[i]
                let delBtnDisable=""
                // if (el.used!=0){
                //   delBtnDisable="disabled"
                // }
                html+=`<tr>
                           <td>
                            <button type="button" name="" id="showBtn${el.id}" 
                            class="btn btn-primary btn-xs showInoculi" style="width:25px"
                            idInoculi="${el.id}" >
                              <i class="fa fa-eye fa-sm" aria-hidden="true"></i>
                          </button>
                          <button type="button" name="" id="delete${el.id}" 
                          class="btn btn-danger btn-xs deleteInoculi_Btn" style="width: 25px" 
                          idInoculi="${el.id}"  ${delBtnDisable}>
                            <i class="fa fa-trash fa-sm " aria-hidden="true"></i>
                          </button>
                        </td>
                                <td>${el.code_inoculum}</td>
                                <td>${el.inoculum_name}</td>
                                <td>${el.n_container} - ${el.container.container_name}</td>
                                <td>${el.strain.strain_name} ${el.strain.species_code} </td>
                                <td>${moment(el.createdAt).format("DD-MM-YY")}</td>
                            </tr>`
                
                }
                await tableInoculi.clear().rows.add($(html)).draw();
            }
    });
    $("#inoculi_Table").show();
    $("#inoculi_Data").hide();
    $("#newInoculi_Btn").show();
}
// Draw table Child element 
function drawTableChild(data,table,fields,topic,title) {
    let html=""
    console.log(data.length)
    if (data.length>0){
      for (let i = 0; i < data.length; i++) {
        const elem = data[i];
        html+=`<tr>
        <td>
          <button type="button" name="" id="showChildBtn_${elem.id}" 
                  class="btn btn-primary btn-xs showChild_btn" style="width:25px"
                  topic="${topic}">
                    <i class="fa fa-eye fa-sm" aria-hidden="true"></i>
                </button>
        </td>`
        for (let y = 0; y < fields.length; y++) {
          const fld = fields[y];
          html+=`<td>${elem[fld]}</td>`
        }
        html+=`</tr>`
      }
      
    } else {
      html+=`<tr >
        <td colspan="4" style="text-align:center" class="bg-danger"> Il materiale non è utilizzato in nessuno ${title}</td>
      </tr>`
    }
    $("#"+table).html(html)
  }
  async function drawShowInoculi(id) {
    $("#inoculi_Data").show();
    $("#inoculi_Table").hide();
    await $.ajax({
        type: "GET",
        url: "/inoculum/getOneInoculum?id="+id,
        success: async function (response) {
          console.log(response)
          let data=response.inoculum
          let seeds=response.seeds
          dataElement=data
          // Populate GUI
          for (const [key, value] of Object.entries(data)) {
              if($("#"+key+"_Fld").attr("tp")=="textField"){
                $("#"+key+"_Fld").val(value)
              }
              if($("#"+key+"_Fld").attr("tp")=="selectField"){
                $("#"+key+"_Fld").val(value).change();
              }
              switch (key) {
                case "containerId":
                  $("#containerId_Show").html(data.container?data.container.container_name:"-")
                  break;
                case "storageId":
                  $("#storageId_Show").html(data.storage?data.storage.code_storage+" "+data.storage.name_storage:"-")
                  break;     
                case "strainId":
                  $("#strainId_Show").html(data.strain.species_code+" - "+ data.strain.strain_name)
                  $("#strainId_Fld").val(data.strainId)
                  break;
                case "substrateId":
                  $("#substrateId_Show").html(data.substrate.name_substrate)
                  $("#substrateId_Fld").val(data.substrateId)
                  break;
                  case "exp_date":
                    $("#exp_date_Show").html(moment(data.exp_date).format("DD-MM-YY"))
                    break;
                  case "createLot":
                    $("#createLot_Show").html(moment(data.exp_date).format("DD-MM-YY"))
                    break;
                  case "expected_maturation_date":
                    $("#expected_maturation_date_Show").html(moment(data.expected_maturation_date).format("DD-MM-YY"))
                    break;
                   case "purchased":
                    $("#purchased_Show").html(data.purchased===1? "Sì" : "No")
                    $("#purchased_Fld").attr("checked",data.purchased? true : false)
                    break;
                   case "fromSample":
                    $("#fromSample_Show").html(data.fromSample===1? "Sì" : "No")
                    $("#fromSample_Fld").attr("checked",data.fromSample? true : false) 
                    break;
                    case "sampleType":
                      let sampleType=await sampleTypeDD.find(el=> {return el.val==data.sampleType})
                      if((sampleType)&&(sampleType.length>0)){
                        $("#sampleType_Show").html(sampleType.txt)
                      } else {
                        $("#sampleType_Show").html("-")
                      }
                    break;
                    case "supplierId":
                      if(data.supplierId){
                        $("#supplierId_Show").html(data.supplier.supplier_name?data.supplier.supplier_name:"-")
                      }else{
                        $("#supplierId_Show").html("-")
                      }
                      break;
                      case "purchased_date":
                        $("#purchased_date_Show").html(data.purchased_date?moment(data.purchased_date).format("DD-MM-YY"):"-")
                        break;
                default:
                  $("#"+key+"_Show").html(value?value:"-")
                  break;
                }
            }
          $("#id_Fld").val(data.id)
          if (response.inoculum.used>0){
              $("#saveInoculi_Btn").hide()
              await drawTableInoculi()
              $("#rowInoculi").show()
              $("#addElement_Btn").prop("disabled","true")
              $(".delElement_Btn").prop("disabled","true")
            } else {
              $("#rowInoculi").hide()
              $("#addElement_Btn").removeAttr("disabled")
              $(".delElement_Btn").removeAttr("disabled")
            }
            await drawTableMushElement(response.inoculum.mushElements,"INOCULUM")
           
            if (seeds.length>0){
              let html=""
              for (let i = 0; i < seeds.length; i++) {
                const elem = seeds[i];
                html+=`<tr>
                  <td>${elem.mushElementCode}</td>
                  <td></td>
                  </tr>`
              }
             $("#setSeed_Tblb").html(html)
             $("#setSeed_Tbl").show()
            }else{
              $("#setInoculo_Row").hide() 
            }
            
          $("#pdfStrain_Btn").show();
           $("#saveInoculo_Btn").hide()
          $("#abortInoculo_Btn").hide()
          $("#modInoculo_Btn").show();
          $("#titoloForm").html(` ${response.inoculum.code_inoculum} 
                <button type="button" class="btn btn-xs btn-primary" id="pdfStrain_Btn"><i class="fa fa-print" aria-hidden="true"></i></button>
          `)
          $("#backToMain_Btn").show();
          $("#newInoculi_Btn").hide();
          $(".inoculiForm").hide()
          $(".inoculiText").show()
        }
      });   

  }
 function drawTableMushElement(data,topic) {
    let html=""
    console.log(data)
    
    if (data.length>0){
      for (let i = 0; i < data.length; i++) {
        const elem = data[i];
        let delBtnDisable=""
        let classTr=""
        let classDD="destinationDD"
        let enableDD=""
        if(elem.active==0){
          classTr="text-danger"
          enableDD="disabled"
        }
        html+=`<tr class="${classTr}">
        <td>
          <button type="button" name="" id="showChildBtn_${elem.id}" 
                  class="btn btn-primary btn-xs showChild_btn" style="width:25px"
                  topic="mushElement">
                    <i class="fa fa-eye fa-sm" aria-hidden="true"></i>
                </button>
        </td>
        <td>${elem.element_code}</td>
        <td>${elem.stato}</td>
        <td>${elem.storage.name_storage}</td>
        <td>${elem.mushElementNotes.length}</td>
        <td>${elem.pick_date?moment(elem.pick_date).format("DD-MM-YYYY"):"-"}</td>
        
        `
        
        html+=`</tr>`
      }
      
    } else {
      html+=`<tr >
        <td colspan="4" style="text-align:center" class="bg-danger"> Il materiale non è utilizzato in nessuno ${title}</td>
      </tr>`
    }
    $("#mushElement_Tblb").html(html).parent().show()
  }
 
  $(document).ready(async function () {
    
    $('#exp_date_DT').datetimepicker({locale: 'it', format:"DD-MM-YY"})
    $('#expected_maturation_date_DT').datetimepicker({locale: 'it', format:"DD-MM-YY"})
    $('#purchased_date_DT').datetimepicker({locale: 'it', format:"DD-MM-YY"})
    $("#createLot_DT").datetimepicker({locale: 'it', format:"DD-MM-YY"})
   
     if (redirectId!=null){
      await drawShowInoculi(redirectId)
    }
    else{
      tableInoculi=$('#inoculi_Tbl').DataTable({responsive: true,pageLength: 50})
      $("#mushElement_Div").hide()
      await drawTableInoculi()
    }

    $(document).on("click",".showInoculi",async function(){
      let idinoculi=$(this).attr("idinoculi")
      window.location="/inoculum?redirectId="+idinoculi
    })

    $("#newInoculi_Btn").click(function (e) { 
      e.preventDefault();
      resetForm("inoculi_FRM")
       $("#createLot_DT").datetimepicker('defaultDate',moment())
      $('#code_inoculum_Wrp').hide();
      $("#addSeedTbl_Div").hide()
      $("#inoculi_Data").show();
      $("#inoculi_Table").hide();
      $("#saveNewInoculo_Btn").show();
      $("#selInoculo_BtnMdl").show();
      $("#backToMain_Btn").show();
      $(this).hide()
    });

    $("#saveNewInoculo_Btn").click(function (e) { 
      e.preventDefault();
      let f=checkForm("inoculi_FRM")
      if (f==true){
      let c=confirm("Inserire l'elemento inoculo? L'operazione non è annullabile")
        if(c==true){
        $.ajax({
          type: "POST",
          url: "/inoculum/newInoculum",
          data: $("#inoculi_FRM").serialize(),
          success: function (response) {
            console.log(response)
            drawTableInoculi()
          } 
        });
      }}
    });

    $("#modInoculo_Btn").click(function (e) { 
      e.preventDefault();
      
    });
    //showChild_btn
    $(document).on("click",".showChild_btn", function (e) {
      e.preventDefault()
      let topic=$(this).attr("topic")
      let id=$(this).attr("id").split("_")[1]
      console.log(topic)
      switch (topic) {
        case "mushElement":
          window.open('/mushElement/singleMushElement?id='+id+'&filterCategory=INOCULUM', '_blank');
          break;
      }

    })
    /** Cancella lotto */
    $(document).on("click",".deleteInoculi_Btn",async function(){
      let idInoculi=$(this).attr("idInoculi")
      console.log(idInoculi)
       if(confirm("Sei siscuro di voler cancellare il lotto di inoculo? Facendo così eliminerai tutti gli elementi associati.")){
        $.ajax({
        type: "delete",
        url: "/inoculum/deleteInoculum?inoculumId="+idInoculi+"&forceDelete=false",
        success: function (response) {
          console.log("res")
           window.location="/inoculum"
        },
        error:function(err){
          console.log(err.responseText)
          let c=confirm("Attenzione, l'elemento è associato a uno o più elemnti, forzare l'eleiminazione? Continuando verranno eliminati tutti gli elementi collegati a questo codice")
          if (c==true){
            $.ajax({
            type: "delete",
            url: "/inoculum/deleteInoculum?inoculumId="+idInoculi+"&forceDelete=true",
            success: function (response) {
              window.location="/inoculum"
            }})
          }
        }
      });
      }
      
    })

    /** Visualizza elemento */
    $(document).on("click",".showChild_btn", function (e) {
      e.preventDefault()
      let topic=$(this).attr("topic")
      let id=$(this).attr("id").split("_")[1]
      console.log(topic)
      switch (topic) {
        case "mushElement":
          window.open('/mushElement/singleMushElement?id='+id+'&filterCategory=SPAWN', '_blank');
          break;
        case "seedElement":
          window.open('/mushElement/singleMushElement?id='+id+'&filterCategory=SPAWN', '_blank');
        break;
      }

    })
     /** Live Search */
    $("#liveSearch").keyup(function (e) { 
      e.preventDefault();
      let str=$(this).val()
      console.log(str)
      if(str!=""){
         $.ajax({
        type: "GET",
        url: "/inoculum/liveSearch?str="+str,
        success: function (response) {
          let element=response.list
          inoculiList=element
            console.log(inoculiList)
            console.log(tempInoculiArray)

          let html=`<div class="col-12">
                  <table class=" w-100 table table-sm">`
                    
          if (element.length>0){
            
            html+=`<thead >
                        <tr>
                          <th></th>  
                          <th>Codice</th>  
                          <th>Disponiblità</th>  
                          <th>Prelievo</th> 
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>`
          element.forEach(elem=>{
            elem.requestQt=0
            let disableBtn=""
            let inList=[]
            for (let i = 0; i < tempInoculiArray.length; i++) {
              const e = tempInoculiArray[i];
              if(e.element.element_code==elem.element_code){
                        inList.push(e) 
                      }
            }

            console.log(inList)

            if (inList.length>0){
              elem.perc=inList[0].tempQt
              elem.requestQt=inList[0].requestQt
              disableBtn="disabled"
            }

            html+=`
                    <tr>
                      <td class="text-xs"><span class="badge badge-secondary">${elem.type}</span></td>
                      <td class="">${elem.element_code}</td>
                      <td>${elem.perc}%</td>
                      <td>
                        <div class="form-group m-0 p-0">
                        <input type="number"
                          class="form-control py-1 "
                          style="height: 30px;"
                          id="inoculo_${elem.element_code}" type="${elem.type}" element_code="${elem.element_code}" 
                          max="${elem.perc}"
                          min="0"
                          value="${elem.requestQt}"
                          ${disableBtn}
                          >
                        </div>
                      </td>
                      <td><button  type="${elem.type}" element_code="${elem.element_code}" class="btn btn-primary btn-xs addSeed" ${disableBtn}> Aggiungi </button></td>
                    </tr>
                 `
          })
          html +=`<tbody>`
          } else {
            html+=`<tr>
                      <td > Non sono presenti elementi </td>
                  </tr>`
          }
          html +=`</table>
            </div>`
          $("#liveResult_Div").html(html)
        }
      });
    
      }
     });
     /** Gestione seeds */
    $(document).on("click",".addSeed", function (e) {
       e.preventDefault();
      let elementCode=$(this).attr("element_code")
      let requestQt=$("#inoculo_"+elementCode).val()
      var element = inoculiList.filter(a => {
        if(a.element_code==elementCode){
          return a
        }
      });
      console.log(element)
     tempInoculiArray.push({element:element[0],requestQt:requestQt,tempQt:element[0].perc-requestQt})
     console.log(tempInoculiArray)
     let html=`<div class="col-12">
                  <table class=" w-100 table table-sm">
                      <thead >
                        <tr>
                            
                          <th>Codice</th>  
                          <th>Prelievo %</th>  
                          <th>Qt avanzo %</th> 
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>`
     tempInoculiArray.forEach((elem,i)=>{
        html+=`<tr id="rowInoculo_${i}">

                <td scope="row"> <input type="hidden" name="inoculumElementId" value="${elem.element.element_code+"|"+elem.element.id+"|"+elem.requestQt+"|"+elem.tempQt}">${elem.element.element_code}</td>
                <td>${elem.requestQt}%</td>
                <td>${elem.tempQt}%</td>
                <td>
                  <button class="btn btn-danger btn-xs deleteSeed" 
                          id="deleteSeed_${i}" style="width: 25px"> 
                          <i class="fa fa-trash fa-sm " aria-hidden="true"></i> 
                  </button>
                  </td>
              </tr>`
     })
     html+="</tbody></table>"
      $("#addSeedTbl_Div").html(html).show()
      $("#saveNewSpawn_Btn").prop("disabled",false);
      $('#inoculiModal').modal('hide')
      $("#liveResult_Div").html("")
      $("#liveSearch").val("")

    });
    $(document).on("click",".deleteSeed", function (e) {
       e.preventDefault();
       let idArrayInoculi=$(this).attr("id").split("_")[1]
       $("#rowInoculo_"+idArrayInoculi).remove()
       tempInoculiArray.splice(idArrayInoculi,1)

    });
    
     /** Gestione date */
    let incubation_len=0
    let creationDate=moment().format("DD-MM-YY")
    $("#strainId_Fld").change(async function (e) { 
      e.preventDefault();
      let val=$(this).val()
      await $.ajax({
        type: "GET",
        url: "/strain/getOneStrain?id="+val,
        success: function (response) {
          incubation_len=response.strain.incubation_len?parseInt(response.strain.incubation_len.length>0?response.strain.incubation_len.split("-")[0]:response.strain.incubation_len):0
          creationDate=$('#createLot_DT').datetimepicker('defaultDate')
         $('#expected_maturation_date_DT [name="expected_maturation_date"]').attr("value",moment(creationDate,"DD-MM-YY").add(incubation_len,'d').format("DD-MM-YY"))
        }
      });
    });
    
    $("#createLot_DT").on("change.datetimepicker", function (e) {
      e.preventDefault();
      creationDate=e.date
      $('#expected_maturation_date_DT [name="expected_maturation_date"]').attr("value",moment(creationDate,"DD-MM-YY").add(incubation_len,'d').format("DD-MM-YY"))
    });

    /** Gestione elemento acquistato */
    $("#purchased_Fld").change(function (e) { 
      e.preventDefault();
      let val=$(this).prop("checked")
      console.log(val)
      if (val){
        $("#selInoculo_BtnMdl").prop("disabled",true)
        $("#saveNewSpawn_Btn").prop("disabled",false)
        $("#setInoculo_Row").hide();
        $("#fromSample_Fld").prop("disabled",true)
        $("#sampleType_Fld").prop("disabled",true)
        $("#supplierId_Fld").prop("disabled",false)
      }else{
        $("#fromSample_Fld").prop("disabled",false)
        $("#sampleType_Fld").prop("disabled",true)
        $("#supplierId_Fld").prop("disabled",true)
        $("#selInoculo_BtnMdl").prop("disabled",false)
        $("#saveNewSpawn_Btn").prop("disabled",true)
        //$('#substrateId_Fld option').each(function() {$(this).css('display', 'contents');})
        $("#setInoculo_Row").show();
      }
    });

    $("#fromSample_Fld").change(function (e) { 
      e.preventDefault();
      let val=$(this).prop("checked")
      console.log(val)
      if (val){
        $("#selInoculo_BtnMdl").prop("disabled",true)
        $("#saveNewSpawn_Btn").prop("disabled",false)
        $("#setInoculo_Row").hide();
        $("#purchased_Fld").prop("disabled",true)
        $("#sampleType_Fld").prop("disabled",false)
        $("#supplierId_Fld").prop("disabled",true)
      }else{
        $("#selInoculo_BtnMdl").prop("disabled",false)
        $("#saveNewSpawn_Btn").prop("disabled",true)
        $("#purchased_Fld").prop("disabled",false)
        $("#sampleType_Fld").prop("disabled",true)
        $("#supplierId_Fld").prop("disabled",true)
        $("#setInoculo_Row").show();
      }
    });

    /** Movimentazione elementi */
    $(document).on("click",".movimentazioneBtn",function(){
      $("#movimentaIdElement").val(dataElement.id)
      $("#movimentaTypeElement").val(dataElement.mushElements[0].type)
      $("#movimentazioni_MdlTitleId").html("Lotto Spawn:"+dataElement.code_inoculum)
      let storageSelectOption
      storagesDD.forEach(elem => {
        storageSelectOption+= `
        <option value="${elem.val}">${elem.txt}</option>
        `   
      });
      $("#movimentaAll_Sel").html(storageSelectOption)
      $("#movimentaFrom_Sel").html(storageSelectOption).val(dataElement.storageId)
      let html
      for (let i = 0; i < dataElement.mushElements.length; i++) {
        const elem = dataElement.mushElements[i];
        console.log(elem)
        let classTr=""
        let classDD="destinationDD"
        let enableDD=""
        if(elem.active==0){
          classTr="text-danger"
          enableDD="disabled"
          classDD=""
        }
        storageSelectOption=""
        for (let y = 0; y < storagesDD.length; y++) {
          const e = storagesDD[y];
          storageSelectOption+= `<option value="${e.val}|${elem.id}|${elem.storageId}">${e.txt}</option>`   
          
        }
        html+=`<tr class="${classTr}">
        <td>
          ${elem.element_code}
        </td>
        <td>
          ${elem.storage.code_storage} - ${elem.storage.name_storage}
        </td>
        <td>
                    <div class="form-group m-0 p-0">
                        <select tp="selectField" class="form-control form-control-sm form-control-minimal ${classDD}" name="destinationDD" ${enableDD}>
                             <option value="${elem.storage.id}|${elem.id}|${elem.storageId}">${elem.storage.code_storage} - ${elem.storage.name_storage}</option>
                             <option disabled="disabled">----</option>
                            ${storageSelectOption}
                        </select>
                    </div>
        </td>
        `
      }
      $("#movimenti_Tblb").html(html)
      $("#movimentazioni_Mdl").modal("show")
    })
    $("#movimentaAll_Ckb").change(function (e) { 
      e.preventDefault();
      let val=$(this).prop("checked")
      console.log(val)
      if (val){
        $(".destinationDD").prop('disabled',true); 
        $(".movimentaAll_Div").show();
        $("#movimentaAll_Sel").prop('disabled', false);
        $("#movimentaFrom_Sel").prop('disabled', false);
      }else{
        $(".destinationDD").prop('disabled', false); 
        $(".movimentaAll_Div").hide()
        $("#movimentaAll_Sel").prop('disabled', true);
        $("#movimentaFrom_Sel").prop('disabled', true);

      }
      
    });
    $("#saveMovimentation").click(function (e) { 
      e.preventDefault();
      $.ajax({
        type: "PUT",
        url: "/mushElement/movimentazioneElement",
        data: $("#movimentazioni_Frm").serialize(),
        success: function (response) {
         window.location='inoculum?redirectId='+dataElement.id
        }
      });
    });
    
    /** Utility */
    $("#exportCsv_Btn").click(function (e) { 
      e.preventDefault();
      let url="/mushElement/csvLotto?relatedId="+dataElement.id+"&filterCategory="+filterCategory
      window.open(url, '_blank').focus();
    });

    $("#pdfStrain_Btn").click(function (e) { 
      e.preventDefault();
       window.open('/inoculum/pdf?idInoculum='+dataElement.id, '_blank');
    });

    /** back to main */
    $("#backToMain_Btn").click(function (e) { 
        e.preventDefault();
         window.location='/inoculum'
      });
  });
 

</script>
<%- include ('../closeTag') %>
