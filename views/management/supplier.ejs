<%- include ('../header') %>
<%- include ('../navbar') %>
<%- include ('../sidebar') %>

  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Gestione fornitori 
            <button class="btn btn-xs btn-primary" id="modSupplier_Btn" style="display: none;"><i class="fas fa-plus"></i> Modifca substrate</button>
              <button type="button" class="btn btn-xs btn-primary" id="newSupplier_Btn"><i class="fas fa-plus"></i> Nuova fornitore</button>
              <button class="btn btn-xs btn-primary" id="backToMain_Btn" style="display: none;"> <i class="fas fa-long-arrow-alt-left"></i> Torna a elenco fornitori</button>
            </h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Ricette</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
    <section class="content">
      <div class="container-fluid" >
        <div class="row" style="width: 100%;">
          
          <!-- Raw material card -->
          <div class="card w-100" id="tableSupplier_Crd">
            <div class="card-body">
              <table class="display table table-striped table-bordered compact" id="supplier_Tbl" style="width: 100%;">
                <thead>
                    <tr>
                        <th style="width: 45px; "></th>
                        <th>Codice fornitore</th>
                        <th>Nome fornitore</th>
                        <th>Usata in N substrati</th>
                        <th>Creata il</th>
                    </tr>
                </thead>
                <tbody id="supplier_Tblb">
                    
                    
                    
                </tbody>
            </table>
            </div>
          </div>
          <!-- Show/mod Raw MAterial Card -->
          <dvi class="card w-100" id="showSupplier_Crd" style="display: none;">
            <div class="row m-3">
              <div class="col-12">
              <form id="supplier_Form" class="p-3">
                <div class="row w-100">
                    <div class="col">
                  <%- include('../include/ejsForm',
                  {classTxt: "supplierText",
                    classField: "supplierForm",
                    form:[
                    { 
                      type:"hidden",
                      fieldName:"id"
                    },
                    { type:"startRow"},
                    {
                      type:"text",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"supplier_name",
                      label:"Nome fornitore",
                      required:'', 
                    },
                    {
                      type:"text",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"address",
                      label:"Indirizzo",
                    },
                    {
                      type:"text",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"phone",
                      label:"Contatto telefonico",
                    },
                    {
                      type:"text",
                      classBox:"col-md-3 col-sm-6",
                      fieldName:"mail",
                      label:"Email fornitore",
                    },
                    { type:"endRow"},
                    { type:"startRow"},
                    {
                      type:"textarea",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"note",
                      label:"Note",
                    },
                    { type:"endRow"}
                    ]  }) %>
  
                    </div>
                  </div>
                  
              </form>
              <div class="col-12">
                <button type="button" class="btn btn-xs btn-primary" id="saveNewSupplier_Btn"><i class="fas fa-plus"></i> Salva substrato</button>
                <button type="button" class="btn btn-xs btn-primary" id="saveModSupplier_Btn"><i class="fas fa-plus"></i> Salva modifica substrato</button>
              </div>
              </div>
            </div>
            
          </dvi>
</section>
</div>


<%- include ('../footer') %>
<%- include ('../jsLoad') %>
<script>

 //let materialCategory = '<%# JSON.stringify(materialCategory) %>'
 //materialCategory=JSON.parse(materialCategory)
let tableSupplier
let idSupplier
// Draw Category Drop down
function drawCategoryDD(){
  let html=""
  materialCategory.forEach(el => {
    html+=`<option value="${el.id}">${el.category_name}</option>`
  });
   $('#categoryDD_Fld').html(html)
  
}
// Draw and update table
async function  drawTable (){
   await $.ajax({
        type: "GET",
        url: "/supplier/getAll",
        success: async function (response) {
          console.log(response)
            let html=""
            for (let i = 0; i < response.suppliers.length; i++) {
                let el=response.suppliers[i]
                let delBtnDisable=""
                // if (el.used!=0){
                //   delBtnDisable="disabled"
                // }
                html+=`<tr>
                           <td>
                            <button type="button" name="" id="showBtn${el.id}" 
                            class="btn btn-primary btn-xs showSupplier" style="width:25px"
                            idSupplier="${el.id}" supplierName="${el.supplier_name}">
                              <i class="fa fa-eye fa-sm" aria-hidden="true"></i>
                          </button>
                          <button type="button" name="" id="delete${el.id}" 
                          class="btn btn-danger btn-xs deleteSupplier_Btn" style="width: 25px" 
                          idSupplier="${el.id}" supplierName="${el.supplier_name }" ${delBtnDisable}>
                            <i class="fa fa-trash fa-sm " aria-hidden="true"></i>
                          </button>
                        </td>
                                <td>${el.supplier_name}</td>
                                <td>${el.supplier_name}</td>
                                <td>${el.used}</td>
                                <td>${moment(el.createdAt).format("DD-MM-YY HH:mm")}</td>
                            </tr>`
                
                }
                await $('#supplier_Tbl').DataTable().clear().rows.add($(html)).draw();
            }
    });

}

$(document).ready(async function () {
  // init
    
    tableSupplier=$('#supplier_Tbl').DataTable({responsive: true});
    await drawTable()
    
    // Card
    // New rawMAterial
  $("#newSupplier_Btn").click(async function (e) { 
    e.preventDefault();
    $("#supplier_Form").trigger("reset")   
    $(".supplierForm").show()
    $(".supplierText").hide()
    $("#rowSupplier").hide() 
    $("#newSupplier_Btn").hide()
    $("#backToMain_Btn").show()
    $("#tableSupplier_Crd").hide()
    $("#showSupplier_Crd").show()
    $("#element_Row").hide()
    $("#saveSupplier_Btn").show()
  });
  // --> New supplier
  $("#saveNewSupplier_Btn").click(function (e) { 
    e.preventDefault();
    $("#cod_supplier_Fld").removeAttr("disabled")
    $.ajax({
        type: "POST",
        url: "/supplier/newSupplier",
        data: $("#supplier_Form").serialize(),   
        success: async function (response) {
          window.location="/supplier"
        }
      });
   
    });
   // --> New supplier
   $("#saveModSupplier_Btn").click(function (e) { 
    e.preventDefault();
    $.ajax({
        type: "PUT",
        url: "/supplier/updateSupplier",
        data: $("#supplier_Form").serialize(),   
        success: async function (response) {
          await drawTable()
          $("#showSupplier_Crd").hide()
          $("#tableSupplier_Crd").show()
          $("#newSupplier_Btn").show()
          $("#modSupplier_Btn").hide()
          $("#backToMain_Btn").hide()
          $("#saveNewSupplier_Btn").hide()
          $("#saveModSupplier_Btn").hide()
          $("#saveSupplier_Btn").show()
          $(".supplierForm").hide()
          $(".supplierText").show()
          $('#supplier_Form')[0].reset();
        }
      });
    });
  
    // Back to main
  $("#backToMain_Btn").click(async function (e) { 
    e.preventDefault();
    await drawTable()
    $("#newSupplier_Btn").show()
    $("#backToMain_Btn").hide()
    $("#newSupplier_Crd").hide()
    $("#showSupplier_Crd").hide()
    $("#tableSupplier_Crd").show()
    $("#modSupplier_Btn").hide()
    $("#saveNewSupplier_Btn").hide()
    $("#saveModSupplier_Btn").hide()
  });  
  // Show/mod Raw material
  $(document).on("click",".showSupplier", async function(e){
      $("#saveSupplier_Btn").hide()

      let id=$(this).attr("idSupplier")
      idSupplier=id
      let supplierName=$(this).attr("supplierName")
      await $.ajax({
        type: "GET",
        url: "/supplier/getOneSupplier?id="+id,
        success: async function (response) {
          let data=response.supplier
          // Populate GUI
          for (const [key, value] of Object.entries(data)) {
              if($("#"+key+"_Fld").attr("tp")=="textField"){
                $("#"+key+"_Fld").val(value)
              }
              if($("#"+key+"_Fld").attr("tp")=="selectField"){
                $("#"+key+"_Fld").val(value).change();
              }
                $("#"+key+"_Show").html(value?value:"-")
            }
            $("#id_Fld").val(data.id)
          if (response.supplier.used>0){
              $("#saveSupplier_Btn").hide()
              await drawTableSupplier()
              $("#rowSupplier").show()
              $("#addElement_Btn").prop("disabled","true")
              $(".delElement_Btn").prop("disabled","true")
            } else {
              $("#rowSupplier").hide()
              $("#addElement_Btn").removeAttr("disabled")
              $(".delElement_Btn").removeAttr("disabled")
            }
          $("#showSupplier_Crd").show()
          $("#tableSupplier_Crd").hide()
          $("#newSupplier_Btn").hide()
          $("#saveNewSupplier_Btn").hide()
          $("#saveModSupplier_Btn").show()
          $("#modSupplier_Btn").show()
          $("#backToMain_Btn").show()
          $(".supplierForm").hide()
          $(".supplierText").show()
        }
      });   
    })
    $("#modSupplier_Btn").click(function (e) { 
      e.preventDefault();
      $(".supplierForm").show()
      $(".supplierText").hide()
    }); 

    // Delete supplier
    $(document).on("click",".deleteSupplier_Btn", async function(e){
      e.preventDefault();
      let id=$(this).attr("idSupplier")
      let c=confirm(`Stai eliminando una fornitore, vuoi continuare? `)
      if (c==true){
        $.ajax({
        type: "DELETE",
        url: "/supplier/deleteSupplier?id="+id,
        success: async function (response) {
          await drawTable()
        }
      });
      }
    })
});
    

</script>
<%- include ('../closeTag') %>
