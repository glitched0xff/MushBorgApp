<%- include ('../header') %>
<%- include ('../navbar') %>
<%- include ('../sidebar') %>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Gestione substrati</h1>
            <button class="btn btn-xs btn-primary" id="modSubstrate_Btn" style="display: none;"><i class="fas fa-plus"></i> Modifca substrate</button>
            <button class="btn btn-xs btn-primary" id="backToMain_Btn" style="display: none;"> <i class="fas fa-long-arrow-alt-left"></i> Torna ai materiali</button>
            <button class="btn btn-xs btn-primary" id="newSubstrate_Btn"><i class="fas fa-plus"></i> Crea substrato</button>
          </div>
          
        </div>
      </div>
    </div>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <!-- Substrate card -->
          <div class="card w-100" id="tableSubstrate_Crd">
            <div class="card-body">
              <table class="display table table-striped table-bordered compact" id="substrate_Tbl" style="width: 100%;">
                <thead>
                    <tr>
                        <th style="width: 40px; "></th>
                        <th>Codice substrati</th>
                        <th>Nome substrati</th>
                        <th style="width: 200px; ">Specie</th>
                        <th>Generazione</th>
                        <th>Usata in N substrati</th>
                        <th>Creata il</th>
                    </tr>
                </thead>
                <tbody id="substrate_Tblb">
                    
                </tbody>
            </table>
            </div>
          </div>
          <!-- Show/mod substrates Card -->
          <div class="card w-100" id="showSubstrate_Crd" style="display: none;">
            <div class="row m-3">
              <div class="col-12">
              <form id="substrates_Form" class="p-3">
                <div class="row w-100">
                    <div class="col">
                  <%- include('../include/ejsForm',
                  {form:[
                    { 
                      type:"hidden",
                      fieldName:"id"
                    },
                    { type:"startRow"},
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"cod_substrate",
                      label:"Codice substrato",
                      step:"",
                      readonly:'if not required delete it', 
                    },
                    {
                      type:"text",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"name_substrate",
                      label:"Nome substrato",
                      step:"",
                      required:'if not required delete it', 
                    },
                    {
                      type:"select",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"recipeId",
                      label:"Ricetta",
                      required:'if not required delete it', 
                      option:recipeDD
                    },
                    {
                      type:"number",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"qt",
                      label:"QuantitÃ  substrato",
                      required:'if not required delete it',
                    },
                    {
                      type:"select",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"uom",
                      label:"Udm",
                      required:'if not required delete it',
                      option:[{val:"Kg",txt:"Kg"},{val:"Gr",txt:"Gr"},{val:"Qt",txt:"Qt"}]
                    },
                    {
                      type:"select",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"pretreatmentId",
                      label:"Pretrattamento",
                      required:'if not required delete it', 
                      option:pretreatmentDD
                    },
                    { type:"endRow"},
                    { type:"startRow"},
                    {
                      type:"textarea",
                      classBox:"col-md-2 col-sm-6",
                      fieldName:"note",
                      label:"Note",
                      required:'if not required delete it', 
                    },
                    { type:"endRow"},
                    // { type:"hidden",
                    // fieldName:"recipe_name_Fld"
                    // let recipe_name=$("#recipe_name").html()
                    // console.log(recipe_name)
                    // }
                    ]  }) %>
  
                    </div>
                  </div>
              
              </form>
              </div>
            </div>
            <hr>
            Row recipe
            <div class="row m-3" id="rowRecipe" >
              <div class="col-12">
                <div class="row">
                  <dl class="col-3">
                    <dt>cod_recipe</dt>
                    <dd id="cod_recipe"></dd>
                  </dl>
                  <dl class="col-3">
                    <dt>recipe_name</dt>
                    <dd id="recipe_name"></dd>
                  </dl>
                  <dl class="col-3">
                    <dt>note</dt>
                    <dd id="noteRecipe"></dd>
                  </dl>
                </div>        
                <div class="row w-100">
                  <table id="recipeElement_Tbl" class="table w-100">
                    <thead>
                      <tr>
                        <th>Categoria</th>
                        <th>Percentuale</th>
                        <th>Materiale</th>
                        <th>Qt. umida</th>
                        <th>Qt. secca</th>
                      </tr>
                    </thead>
                    <tbody id="recipeElement_Tblb">

                    </tbody>
                  </table>
                </div>
              
                  <div class="col-12">
                    <button type="button" class="btn btn-xs btn-primary" id="saveNewSubstarte_Btn"><i class="fas fa-plus"></i> Salva substrato</button>
                  </div>
                </div>
            </div>
            row substrate
            <div class="row m-3" id="rowSubstrate">
              <div class="col">
                 <div class="row" >
                    <div class="col-12 h5">
                      Elementi substrato
                    </div>
                  <table class="table table-sm " id="substrate_Tbl">
                    <thead>
                      <tr>
                        <th>Cat materiale</th>
                        <th>Materiale</th>
                        <th>Fornitore</th>
                        <th>Qt mat. umido</th>
                        <th >Qt mat. secco</th>
                      </tr>
                    </thead>
                    <tbody id="substrateElem_Tblb">
                      
                    </tbody>
                  </table>
                 </div>
              </div>
            </div>
            
          </dvi>  
    </div>
</div>
</section>
<!-- /.content -->
</div>
<!-- /.content-wrapper -->
<%- include ('../footer') %>
<%- include ('../jsLoad') %>
<script>

let tableSubstrate
let recipeId


  async function  drawTable (){
   await $.ajax({
        type: "GET",
        url: "/substrate/getAll",
        success: async function (response) {
          console.log(response)
            let html=""
            for (let i = 0; i < response.substrates.length; i++) {
                let el=response.substrates[i]
                let delBtnDisable=""
                if (el.used!=0){
                  delBtnDisable="disabled"
                }
                html+=`<tr>
                           <td>
                            <button type="button" name="" id="showBtn${el.id}" 
                            class="btn btn-primary btn-xs showSubstrate" style="width:25px"
                            idSubstrate="${el.id}" substrateName="${el.cod_substrate}">
                              <i class="fa fa-eye fa-sm" aria-hidden="true"></i>
                          </button>
                          <button type="button" name="" id="delete${el.id}" 
                          class="btn btn-danger btn-xs deleteSubstrate_Btn" style="width: 25px" 
                          idSubstrate="${el.id}" substrateName="${el.name_substrate}" ${delBtnDisable}>
                            <i class="fa fa-trash fa-sm " aria-hidden="true"></i>
                          </button>
                        </td>
                                <td>${el.cod_substrate}</td>
                                <td>${el.name_substrate}</td>
                                <td>${el.species}</td>
                                <td>${el.generation}</td>
                                <td>${el.used}</td>
                                <td>${moment(el.createdAt).format("DD-MM-YY HH:mm")}</td>
                            </tr>`
                
                }
                await $('#substrate_Tbl').DataTable().clear().rows.add($(html)).draw();
            }
    });
}

$(document).ready(async function () {
  // init
  tableSubstrate=$('#substrate_Tbl').DataTable({responsive: true});
  await drawTable()
  // Show substrate data
  $(document).on("click",".showSubstrate", async function(e){
      $("#saveRecipe_Btn").hide()
      
      let id=$(this).attr("idSubstrate")
      idRecipe=id
      let substratesName=$(this).attr("substratesName")
      await $.ajax({
        type: "GET",
        url: "/substrate/getOneSubstrate?id="+id,
        success: async function (response) {
          console.log(response)
          let data=response.substrate
          if (response.substrate.used>0){
              $("#saveRecipe_Btn").hide()
              $("#rowSubstrate").show()
              $("#addElement_Btn").prop("disabled","true")
              $(".delElement_Btn").prop("disabled","true")
            } else {
              $("#rowSubstrate").show()
              $("#addElement_Btn").removeAttr("disabled")
              $(".delElement_Btn").removeAttr("disabled")

            }
            // Populate GUI
            for (const [key, value] of Object.entries(data)) {
              if($("#"+key+"_Fld").attr("tp")=="textField"){
                $("#"+key+"_Fld").val(value)
              }
              if($("#"+key+"_Fld").attr("tp")=="selectField"){
                $("#"+key+"_Fld").val(value).change();
              }
              if (key=="recipeId"){
                $("#"+key+"_Show").html(response.substrate.recipe_name)
              }else{
                $("#"+key+"_Show").html(value?value:"-")
              }
            }
            let html=""
            let totDry=0
            let totHum=0
            data.substrateElements.forEach(el => {
              totDry=totDry+el.qt_dry
              totHum=totHum+el.qt_hum
              html+=`<tr>
                <td>${el.materialCategory.category_name}</td>
                <td >${el.rawMaterial.material_name}</td>
                <td>${el.rawMaterial.supplier.supplier_name}</td>
                <td>${el.qt_hum}</td>
                <td>${el.qt_dry}</td>
              </tr>`  
            });
            html+=`<tr>
                <td></td>
                <td ></td>
                <td></td>
                <td>${totHum}</td>
                <td>${totDry}</td>
              </tr>`  
            console.log(html)
            $("#substrateElem_Tblb").html(html)
            $("#rowRecipe").hide()
          $("#modSubstrate_Btn").show()
          $("#showSubstrate_Crd").show()
          $("#tableSubstrate_Crd").hide()
          $("#newSubstrate_Btn").hide()
          $("#backToMain_Btn").show()
          $(".elementForm").hide()
          $(".elementText").show()
        }
      });   
    })

    $("#modSubstrate_Btn").click(function (e) { 
      e.preventDefault();
      $(".elementForm").show()
      $(".elementText").hide()
    });
    // New substrate btn
    $("#newSubstrate_Btn").click(async function (e) { 
      e.preventDefault();
      $('#substrates_Form').get(0).reset();
      $("#showSubstrate_Crd").show()
      $("#tableSubstrate_Crd").hide()
      $("#rowSubstrate").hide()
      $("#modSubstrate_Btn").hide()
      $("#newSubstrate_Btn").hide()
      $("#backToMain_Btn").show()
      $(".elementForm").show()
      $(".elementText").hide()
      $("#rowRecipe").show()
      let code=await $.get("/substrate/getSubstrateCode")
       $("#cod_substrate_Fld").val(code.subCode)
    });
    // Manage change receipe and prepare table for set
    $("#recipeId_Fld").change(async function (e) { 
      e.preventDefault();
      let idRecipe=$(this).val()
      recipeId=idRecipe
      $.ajax({
        type: "GET",
        url: "recipes/getOneRecipes?id="+idRecipe,
        success: async function (response) {
          let data=response.recipe
          //console.log(data)
          $("#cod_recipe").html(data.cod_recipe)
          $("#recipe_name").html(data.recipe_name)
          $("#noteRecipe").html(data.noteRecipe)
          //$("#rowRecipe").show()
          let lastCategory=false
          let html=""
          let totHum=0
          let totDry=0
          let uom
          for (let i = 0; i < data.recipeElements.length; i++) {
            let el=data.recipeElements[i]
            let selectList
            //if (el.materialCategoryId!=lastCategory){
              await $.get("rawMaterial/getMaterialByCategory?idCategory="+el.materialCategoryId,
              function (data) { 
                selectList=data.material
                })
              //}
            //console.log(selectList)
            let dropDownMaterial=`<div class="form-group m-0">
              <select class="form-control materialDD" name="" id="subElemFld_${i}">`
                let catName=""
            for (let y = 0; y < selectList.length; y++) {
              const ele = selectList[y];
              catName=ele.materialCategory.category_name
              dropDownMaterial+=`<option value="${ele.id}|${ele.hum_factor}|${i}" >${ele.material_name}</option>`  
            }
            dropDownMaterial+=`</select></div>`
            let qtRequest=$("#qt_Fld").val()
            let defaultHum=el.materialCategory.hum_factor
            let qtPerc=qtRequest*(el.percentage/100)
            let matDry=qtPerc/defaultHum
            uom=$("#uom_Fld").val()
            totHum=totHum+parseFloat(qtPerc.toFixed(2))
            totDry=totDry+parseFloat(matDry.toFixed(2))
            html+=`<tr id="subElement_${i}">
                <td>${catName}<input type="hidden" id="materialCategoryId_${i}" value="${el.materialCategoryId}"></td>
                <td id="percent_${i}">${el.percentage}%</td>
                <td>${dropDownMaterial}</td>
                <td id="qtPerc_${i}">${qtPerc.toFixed(2)} ${uom}</td>
                <td id="materialDry_${i}">${matDry.toFixed(2)} ${uom}</td>
              </tr>`
          }
          html+=`<tr >
                <td></td>
                <td ></td>
                <td></td>
                <td >${totHum} ${uom}</td>
                <td >${totDry} ${uom}</td>
              </tr>`
          $("#recipeElement_Tblb").html(html)
        }
      });
    });
    // Change hum_factor if specify in material
    $(document).on("change",".materialDD",function (e) { 
      e.preventDefault();
      let v=$(this).val().split("|")
      let id=v[0]
      let hum_factor=v[1]
      let rowTblId=v[2]
      let qtRequest=$("#qt_Fld").val()
      let percent=parseInt($("#percent_"+rowTblId).html().slice(0, -1))
      //percent=parseInt(percent)
      let hum_qt=qtRequest*(percent/100)
      let dry_qt=hum_qt/hum_factor
      $("#qtPerc_"+rowTblId).html(hum_qt.toFixed(2))
      $("#materialDry_"+rowTblId).html(dry_qt.toFixed(2))
    });
    // Manage change qt
    $("#qt_Fld").change(function (e) { 
      e.preventDefault();
      if ($(this).val()!=""){
        $("#recipeId_Fld").removeAttr("disabled")
      }
      else{
        $("#recipeId_Fld").prop("disable","true")
      }
    });
    // Save new Substrate
    $("#saveNewSubstarte_Btn").click(async function (e) { 
      e.preventDefault();
      let rname=$("#recipe_name").html()
      $("<input />").attr("type", "hidden")
          .attr("name", "recipe_name")
          .attr("value", rname)
          .appendTo("#substrates_Form");

      await $.ajax({
        type: "POST",
        url: "/substrate/newSubstrate",
        data: $("#substrates_Form").serialize(),
        success: async function (response) {
          console.log(response)
          let newId=response.data.id
          let subElementLen= $('#recipeElement_Tbl tr').length;
          console.log(subElementLen)
          for (let i = 0; i <subElementLen-2; i++) {
            console.log(">> "+i)
            let substrateId=1
            let materialCategoryId =$("#materialCategoryId_"+i).val()
            let rawMaterialId=$("#subElemFld_"+i).val()
            console.log(rawMaterialId)
            rawMaterialId=rawMaterialId.split("|")[0]
            console.log(rawMaterialId)
            let qt_hum=parseFloat($("#qtPerc_"+i).html())
            let qt_dry=parseFloat($("#materialDry_"+i).html())
            let data={
              substrateId:newId,
              recipeId:recipeId,
              materialCategoryId:materialCategoryId,
              rawMaterialId:rawMaterialId,
              qt_dry:qt_dry,
              qt_hum:qt_hum,
            }
            console.log(data)
            await $.ajax({
              type: "POST",
              url: "/substrateElement/newSubstrateElement",
              data: data,
              success: async function (response) {
                console.log(response)
                
              },
              error: function(err){
                alert(err)
              }
            });
          }
        }
      });
      $("#showSubstrate_Crd").hide()
      $("#tableSubstrate_Crd").show()
      $("#newSubstrate_Btn").show()
      $("#modSubstrate_Btn").hide()
      $("#backToMain_Btn").show()
      $("#rowRecipes").hide()
      $(".elementForm").hide()
      $(".elementText").show()
      $("#substrateElem_Tblb").empty()
      $('#substrates_Form')[0].reset();
      await drawTable()
    });

    
    // delete Substrate
    $(document).on("click",".deleteSubstrate_Btn", async function(e){
      e.preventDefault();
      let id=$(this).attr("idSubstrate")
      let substrateNeame=$(this).attr("substrateNeame")
      let c=confirm(`Stai eliminando il  ${substrateNeame}, vuoi continuare? `)
      if (c==true){
        $.ajax({
        type: "DELETE",
        url: "/substrate/deleteSubstrate?id="+id,
        success: async function (response) {
          if (response.checkUse==true){
            alert(response.message)
          }else{
            await drawTable()
          }
          
        }
      });
      }
    })

    $("#backToMain_Btn").click(function (e) { 
      e.preventDefault();
      $("#showSubstrate_Crd").hide()
      $("#tableSubstrate_Crd").show()
      $("#newSubstrate_Btn").show()
      $("#modSubstrate_Btn").hide()
      $("#backToMain_Btn").hide()
      $("#rowRecipes").hide()
      $(".elementForm").hide()
      $(".elementText").show()
      $("#substrateElem_Tblb").empty()
      $('#substrates_Form')[0].reset();
    });

})
</script>
<%- include ('../closeTag') %>
